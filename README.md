# Compare Substrate Weight Files

Compares weight files that where generated by Substrate.
It currently only analyzes the constant factor of the weight. Parsing the linear aspect is missing.

# Install

```sh
cargo install --git https://github.com/ggwpez/substrate-weight-compare swc swc_web
```

Two binaries are now available:
- swc
- swc-web

# Example: Web Interface

Assuming you have a Substrate compatible repository checked out, for example `Polkadot`:

```sh
swc-web --repo ../polkadot
```

then open your browser and try the following:
- [http://localhost:8080/compare/...](http://localhost:8080/compare?old=768bd6655577dbfda140b40fdd4ca16700fcf589&new=b6770460668a7c3ef8df0ac0f3376e1f917a17e8&threshold=10&path_pattern=runtime/**/src/weights/*.rs&method=base&ignore_errors=true#runtime/kusama/src/weights/pallet_election_provider_multi_phase.rs.feasibility_check)

# Example: Compare weight files

Suppose you have some weight files in:
- `OLD=repos/polkadot/` and
- `NEW=my_other_repos/polkadot`   
Compare them with:

```sh
swc compare files --old $OLD/* --new $NEW/*
```

# Example: Compare Polkadot Commits

Compare arbitrary Polkadot commits assuming that you have checked the repo out:

```sh
FROM=20467ccea1ae
TO=ef922a7110eb
THRESHOLD=30

# Compare the commits
swc compare commits $FROM $TO --threshold $THRESHOLD --repo ../polkadot

pallet_scheduler.rs::on_initialize_named_aborted 4957 -> 3406 ns (-31.29 %)
pallet_election_provider_multi_phase.rs::finalize_signed_phase_reject_solution 33389 -> 19348 ns (-42.05 %)
pallet_election_provider_multi_phase.rs::submit 77368 -> 42754 ns (-44.74 %)
pallet_election_provider_multi_phase.rs::on_initialize_nothing 23878 -> 12324 ns (-48.39 %)
pallet_election_provider_multi_phase.rs::finalize_signed_phase_accept_solution 50596 -> 25888 ns (-48.83 %)
pallet_scheduler.rs::on_initialize_resolved 3886 -> 1701 ns (-56.23 %)
pallet_election_provider_multi_phase.rs::on_initialize_open_unsigned 33568 -> 12320 ns (-63.30 %)
pallet_election_provider_multi_phase.rs::on_initialize_open_signed 34547 -> 12500 ns (-63.82 %)
pallet_election_provider_multi_phase.rs::create_snapshot_internal 8835233 -> 47360 ns (-99.46 %)
pallet_scheduler.rs::on_initialize_periodic_resolved 33 -> 0 ns (-100.00 %)
frame_benchmarking_baseline.rs::subtraction 100 -> 131 ns (+31.00 %)
frame_benchmarking_baseline.rs::addition 96 -> 126 ns (+31.25 %)
pallet_scheduler.rs::on_initialize_periodic 5139 -> 7913 ns (+53.98 %)
runtime_common_crowdloan.rs::on_initialize 0 -> 4293 ns (+100.00 %)
```
It prints first the ones that decreased (good) and then the ones that increased (bad) sorted by ascending absolute value.

# Config options

## Path Pattern

Uses the [glob](https://docs.rs/glob/latest/glob/) crate to matche files in the repository path with the given pattern. 
Here are some examples for Polkadot:  
- Weight files of all runtimes: `runtime/*/src/weights/**/*.rs`
- All Kusama weight files: `runtime/kusama/src/weights/**/*.rs`

`weights/**/*.rs` is preferred to `weights/*.rs` to include possible sub-folders like XCM.  
The `mod.rs` file is *always* excluded.  

## Evaluation Method

The evaluation method defines how the weight equation is evaluate (=calculated).  
This is a deciding factor when making a decision whether or not a weight got worse.

- Base: Only consider the constant factor of the weight plus storage operations.
- Worst: This sets all components to 100 and thereby emulating high inputs. This is a best-effort approach until [substrate#11397](https://github.com/paritytech/substrate/issues/11397) is done.

NOTE: The storage weights are currently set to RocksDB Substrate default.  
This will be changed to include the correct values soon.
## Threshold

Filters the results by an absolute percentual threshold.  
The percentages values are calculated as increase or decrease.  
Eg: from 100 to 150 would be +50% and would be included by any threshold >=50.

## Ignore Errors

Silently ignore parse errors. This is useful when using inclusive path patterns.

# Running the Tests



## Integration tests

The test use the Polkadot repo in `repo/Polkadot`.

```sh
git clone https://github.com/ggwpez/substrate-weight-compare
cd substrate-weight-compare
git clone https://github.com/paritytech/polkadot/ repos/polkadot
cargo test --release --all-features
```
